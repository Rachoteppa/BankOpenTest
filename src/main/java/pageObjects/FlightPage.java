package pageObjects;

import java.text.DateFormat;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.List;
import java.util.Set;

import org.openqa.selenium.By;
import org.openqa.selenium.JavascriptExecutor;
import org.openqa.selenium.WebDriver;
import org.openqa.selenium.WebElement;
import org.openqa.selenium.support.FindBy;
import org.openqa.selenium.support.PageFactory;

import logger.Log;
import selenium.Wait;
import selenium.Utils;


import managers.FileReaderManager;

public class FlightPage {
	WebDriver driver;
	
	public FlightPage(WebDriver driver) {
		this.driver = driver;
		PageFactory.initElements(driver, this);
	}
	
	@FindBy(xpath="//span[@class='_160X' and contains(text(),'Flight')]") 
	WebElement flightService;

	@FindBy(css="input#text-box.fl-input") 
	WebElement fromPlace;
	
	@FindBy(xpath="//*[@data-reactid='180']") 
	WebElement toPlace;
	
	@FindBy(xpath="//*[@class=\"_2xgL\"]")
	WebElement fromPlaceList;
	
	@FindBy(name="Departure-Date")
	WebElement departuteCalender;
	
	@FindBy(id="datePickerOnward")
	WebElement departuteCalenderTableId;
	
	@FindBy(xpath="(//*[@class='olTz _3wE8'])[1]")
	WebElement adults;
	
	@FindBy(xpath="(//*[@class='olTz _3wE8'])[2]")
	WebElement children;
	
	@FindBy(xpath="(//*[@class='fl-input fl-valid'])[3]")
	WebElement travellerSelection;
	
	@FindBy(xpath="//*[@class='button button--default button--bold _3LRd']")
	WebElement searchButton;
	
	@FindBy(xpath="(//*[@class='_3etY'])[5]")
	WebElement filterButton;
	
	@FindBy(linkText="Book")
	WebElement bookEle;
	
	public void applyFilter() {
		filterButton.click();
		List<WebElement> fromClass=driver.findElements(By.xpath("//*[@class='_3n0h']"));
		for(WebElement ee:fromClass) {
			String bang=ee.findElement(By.tagName("div")).getText();
			//System.out.println(bang);
			if(bang.contains("IndiGo")) {
				System.out.println("true");
				ee.click();
				break;
			}
		}
		Log.info("Filter applied");
		searchButton.click();
		Log.info("Clicked on search button");
		
	}
	
	public void navigateToFlightPage() {
		flightService.click();
		Log.info("Clicked on flight link");
	}
	
	public void selectTravellers() throws InterruptedException {
		travellerSelection.click();
		Log.info("Clicked on travellers selection");
		adults.click();
		Log.info("Clicked on adults");
		children.click();
		Log.info("Clicked on child");
		searchButton.click();
		Log.info("Clicked on search button");
	}
	
	public void enterFromAndToDetails(String from, String to) throws InterruptedException {
		fromPlace.sendKeys(from);
		
		JavascriptExecutor js =(JavascriptExecutor) driver;
		js.executeScript("window.scrollBy(0,200)");
		 
		List<WebElement> fromClass=driver.findElements(By.xpath("//*[@class='_1WIP']"));
		for(WebElement ee:fromClass) {
			String bang=ee.findElement(By.tagName("span")).getText();
			//System.out.println(bang);
			if(bang.equals("Bengaluru,")) {
				
				//System.out.println("true");
				//ee.findElement(By.tagName("span")).click();
				ee.click();
				break;
			}
		}
		Log.info("Entered form place");
		toPlace.sendKeys(to);
		//Waiting for to list to be displayed. And it cant be handles using explicit wait
				Thread.sleep(2000);  
				List<WebElement> toClass=driver.findElements(By.xpath("//*[@class='_1WIP']"));
				  for(WebElement ee1:toClass) { 
					  String bang=ee1.findElement(By.tagName("span")).getText(); 
					  //System.out.println(bang);
					  if(bang.equals("Mumbai,")) {
						  //System.out.println("true"); 
						  ee1.click(); 
						  break; 
					  } 
		}
		Log.info("Entered To place");
		WebElement departuteCalenderTableId=driver.findElement(By.name("Departure-Date"));
		departuteCalenderTableId.click();
		WebElement ell=driver.findElement(By.id("datePickerOnward"));
		List<WebElement> tabledata=ell.findElements(By.tagName("td"));
				  
		int temp_date = 0;
		int temp_price = 0;
		WebElement elt = null;
		int count = 1;
		for(WebElement cell: tabledata) {
			if(cell.getText().contains(",")) {
				String str =cell.getText().replaceAll(",", "");
				if(count == 1) {
					temp_date  = Integer. valueOf(str.split("\n")[0]);
					temp_price  = Integer. valueOf(str.split("\n")[1]);
					count = 2;
				}
								
				if(count != 1 && temp_price > Integer. valueOf(str.split("\n")[1]) ) {
				   temp_price = Integer. valueOf(str.split("\n")[1]);
				   temp_date = Integer.valueOf(str.split("\n")[0]);
				   elt = cell;
				}
				else if(count != 1 && temp_price == Integer. valueOf(str.split("\n")[1])) {
					if(temp_date > Integer.valueOf(str.split("\n")[0])) {
						temp_date = Integer.valueOf(str.split("\n")[0]);
						elt = cell;
					}
				}
								
			}
		}
		elt.click();
		Log.info("Selected date, which is having less price");
		selectTravellers();
	}
	public void validateTotalPrice() {
		int sum=0;
		List<WebElement> fromClass=driver.findElements(By.xpath("//*[@class='_31lq']//*[@class='_2Pzd']"));
		for(WebElement ee:fromClass) {
			String price=ee.findElement(By.tagName("span")).getText(). replaceAll(",", "");
			sum=sum+ Integer.valueOf(price);
		}
		String totalSum=driver.findElement(By.xpath("//*[@class='_2aVr']")).getText().replaceAll(",", "");
		int grandSum=Integer. valueOf(totalSum.split("\n")[1]);
		if(grandSum==sum) {
			System.out.println("Verified Grand total- Success");
			Log.info("Verified Grand total- Success");
		}
	}
	
	public void validateGrandTotla() throws InterruptedException{
	    String parentWindow=driver.getWindowHandle();
	    bookEle.click();
	    Set<String> handles=driver.getWindowHandles();
	    for(String hand: handles) {
	    	if(parentWindow.equals(hand)) {
	    		System.out.println("ParentWindow");
	    	} else {
	    		driver.switchTo().window(hand);
		    	//Thread.sleep(3000);
	    		Log.info("Switched to new window");
	    		Utils.getScreenShot(driver);
		    	System.out.println(driver.findElement(By.xpath("//span[text()='Fare Breakup']")).isDisplayed());
		    	validateTotalPrice();
	    	}
	    }
	    driver.switchTo().window(parentWindow);
	    Log.info("Switched to parent window");
	}
}
